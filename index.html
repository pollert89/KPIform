<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shotcut icon" href="./bot.ico">
    <title>KPI Data</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js" integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        body {
            height: 100vh;
            max-height: 100vh;
            font-family: 'Prompt', sans-serif;
            background-color: #2EBDBD ;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <div class="d-flex">
                            <a class="nav-link active" aria-current="page" href="#" id="logout-btn">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å</a>
                        </div>
                    </li>
                    <li class="nav-item">
                        <div class="d-flex">
                            <a class="nav-link" href="#" id="account-btn">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏∑‡πà‡∏ô</a>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container-fluid d-flex justify-content-center align-items-center h-100 w-100" id="main-body">
        <div class="mt-3">
            <form id="form1" class="mb-5">
                <div class="row justify-content-center">
                    <div class="col-auto m-2 text-center text-light">
                        <p id="header-p" class="display-5 text-bg-warning rounded-pill p-2 px-3 shadow">‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô KPI</p>
                    </div>
                </div>
                <div class="row justify-content-center">
                    <div class="col-12 text-center m-2">
                        <img alt="profile picture" src="https://sv1.picz.in.th/images/2023/02/05/LijRiz.png" style="display: none; filter: blur(3px) drop-shadow(2px 4px 6px black); max-width: 300px" class="img-fluid rounded-circle shadow" id="profile-picture">
                    </div>
                </div>
                <div class="row justify-content-center">
                    <div class="col-7 col-md-2 m-2">
                        <p id="username" class="h3 fw-bold text-light text-center" style="display: none;"></p>
                    </div>
                </div>
                <div id="input-data" style="display: none;">
                    <div class="row justify-content-start g-3 px-4">
                        <div class="col-md-4">
                            <label for="date" class="form-label h4 text-light">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <select name="date" id="date" class="form-select form-select-lg text-center">
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="keys" class="form-label h4 text-light">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏Å‡∏∏‡∏ç‡πÅ‡∏à</label>
                            <input type="text" class="form-control form-control-lg text-center input-data target" id="keys" name="keys">
                        </div>
                        <div class="col-md-4">
                            <label for="devices" class="form-label h4 text-light">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</label>
                            <input type="text" class="form-control form-control-lg text-center input-data target" id="devices" name="devices">
                        </div>
                        <div class="col-md-4">
                            <label for="customer_meeting" class="form-label h4 text-light">‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤ (‡∏Ñ‡∏ô)</label>
                            <input type="text" class="form-control  form-control-lg text-center input-data" id="customer_meeting" name="customer_meeting">
                        </div>
                        <div class="col-md-4">
                            <label for="target_customer" class="form-label h4 text-light">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏Ñ‡∏ô)</label>
                            <input type="text" class="form-control  form-control-lg text-center input-data" id="target_customer" name="target_customer">
                        </div>
                        <div class="col-md-4">
                            <label for="new_customer_5000" class="form-label h4 text-light">‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô 5,000 (‡∏Ñ‡∏ô)</label>
                            <input type="text" class="form-control  form-control-lg text-center input-data" id="new_customer_5000" name="new_customer_5000">
                        </div>
                        <div class="col-md-4">
                            <label for="name_devices" class="form-label h4 text-light">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
                            <input type="text" class="form-control  form-control-lg text-center" id="name_devices" name="name_devices">
                        </div>
                        <div class="col-12 text-center">
                            <button id="submit" class="btn btn-lg btn-primary" style="min-width: 150px"><i class="bi bi-send-fill"></i>&nbsp;‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <section class="row m-2 p-2 rounded shadow " id="chart-sec" style="height: 40vh; display: none;">
            <div class="col-6 rounded-start p-0 pe-1">
                <div class="bg-success" style="height: 25%; border-top-left-radius: 7px;">
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <p class="h3 text-light" id="target-line"></p>
                    </div>
                </div>
                <div class="bg-warning" style="height: 25%;">
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <p class="h3 text-dark" id="mean-line"></p>
                    </div>
                </div>
                <div class="bg-danger" style="height: 50%; border-bottom-left-radius: 7px;">
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <p class="h3 text-light" id="low-line">‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</p>
                    </div>
                </div>
            </div>
            <div class="col-6 p-0 ps-1 rounded-end">
                <div style="height: 50%; border-top-right-radius: 7px; background-color: #d0cecf;" class="parent-fluid">
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <p class="h3 text-dark" id="blank"></p>
                    </div>
                </div>
                <div class="parent-fluid text-bg-danger" style="height: 50%; border-bottom-right-radius: 7px;">
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <p class="h3" id="line-person"></p>
                    </div>
                </div>
            </div>
    </div>
    </section>
    <div class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" id="modal-regist" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-bg-warning">
                <!-- <div class="modal-header justify-content-center">
                        <p class="modal-title text-danger h1"><i class="fas fa-exclamation-circle"></i>&nbsp; ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>
                    </div> -->
                <div class="modal-body">
                    <form id="form-regist">
                        <p class="modal-title text-center h1"><i class="fas fa-exclamation-circle"></i>&nbsp; ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>
                        <div class="row justify-content-center my-0 py-0">
                            <div class="col-md-6 text-center">
                                <label for="name-select" class="form-label">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
                                <select name="name-select" id="name-select" class="form-select form-select-lg text-center">
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer d-flex justify-content-center">
                    <button type="button" class="btn btn-primary" id="btn-regist">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                </div>
            </div>
        </div>
    </div>
    </div>
    <script>
        const liffId = '1656187634-joNMPmDq'
        // const liffId = '1655873446-MpmBPPzl'
        const script_url = 'https://script.google.com/macros/s/AKfycbw7wDDfdtH5ioB9Z4xSGpDqhWDaJit4xk-M0Ih9K5jsXgtX0qesq2DH-5lGTEyyJ2tY/exec'
        var profile
        // $('#profile-picture').hide()
        // $('#username').hide()
        // $('#input-data').hide()
        // $('#logout-btn').hide()
        // $('#account-btn').hide()
        $(document).ready(() => {
            initApp()
        })
        function initApp() {
            let searchParams = new URLSearchParams(window.location.search)
            let changeAccount = searchParams.get('changeAccount')
            console.log(changeAccount)
            setDate()
            liff.init({ liffId: liffId })
            $.get(script_url, { opt: 'get_name' }, (data) => {
                if (data.status != 'success') return alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î')
                console.log("üöÄ ~ data", data)
                $('#name-select').empty()
                $('#name-select').append(`<option value="" selected disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠</option>`)
                data.name.forEach((name) => {
                    $('#name-select').append(`<option value="${name[1]}">${name[0]}</option>`)
                })
            })
            liff.ready.then(async () => {
                if (changeAccount) {
                    if (liff.isLoggedIn()) liff.logout()
                }
                if (!liff.isLoggedIn()) liff.login()
                if (!liff.isInClient()) {
                    $('#logout-btn').show()
                } else {
                    $('#account-btn').show()
                }
                profile = await liff.getProfile()
                let uid = profile.userId
                $('#profile-picture').attr('src', profile.pictureUrl)
                $('#profile-picture').show(400, () => {
                    $('#username').show(200)
                })
                $('#profile-picture').LoadingOverlay("show",{ background: "rgba(255, 255, 255, 0)", imageColor: "#f2f2f2"})
                $.getJSON(`${script_url}?opt=checkAuth&uid=${uid}`, (json) => {
                    $('#profile-picture').LoadingOverlay("hide")
                    $('#profile-picture').css('filter', 'none').animate({
                        height: '100px',
                    }, 500);
                    $('#username').html(profile.displayName)
                    $('#header-p').removeClass('display-5')
                    $('#main-body').css('margin-top',($('.navbar').position().left+ $('.navbar').outerHeight() +40)+'px')

                    $('#input-data').slideDown(300)
                    console.log("üöÄ ~ json", json)
                    pesonalData = json.gdata
                    if (json.result != 'success') {
                        $('#modal-regist').modal('show')
                    }
                })
            })
        }
        function setDate() {
            let firstday = new Date(new Date().getFullYear(), new Date().getMonth(), 1)
            let lastday = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0)
            let month = new Date().getMonth()
            let year = new Date().getFullYear()
            for (let i = firstday.getDate(); i <= lastday.getDate(); i++) {
                let datestring = new Date(year, month, i).toLocaleString('th-TH', { timeZone: 'Asia/Bangkok', year: 'numeric', month: 'long', day: '2-digit' })
                $('#date').append(`<option value="${i}">${datestring}</option>`)
            }
            $('#date').val(new Date().getDate())
        }
        // $('.target').on('keyup',function () {
        //     let val = $(this).val()
        //     let id = $(this).attr('id')
        //     console.log("üöÄ ~ val", val)
        //     $('#'+id).val(parseInt(val).toLocaleString())
        // })
        $('.input-data').on('keyup', function () {
            let val = $(this).val()
            let newval = parseInt(val.replace(/,/g, '').replace(/[^0-9]/g, '')).toLocaleString()
            if (newval == 'NaN') newval = ''
            $(this).val(newval)
        })
        $('#submit').click(function () {
            $.LoadingOverlay("show")
            event.preventDefault()
            let uid = profile.userId
            let date = $('#date').val()
            let keys = $('#keys').val().replace(/,/g, '')
            let devices = $('#devices').val().replace(/,/g, '')
            let customer_meeting = $('#customer_meeting').val()
            let target_customer = $('#target_customer').val()
            let new_customer_5000 = $('#new_customer_5000').val()
            let name_devices = $('#name_devices').val()
            let data = {
                opt: 'push',
                uid: uid,
                date: date,
                keys: parseInt(keys),
                devices: parseInt(devices),
                customer_meeting: parseInt(customer_meeting),
                target_customer: parseInt(target_customer),
                new_customer_5000: parseInt(new_customer_5000),
                name_devices: name_devices
            }
            console.log("üöÄ ~ data", data)
            $.get(script_url, data, (res) => {
                $.LoadingOverlay("hide")
                if (res.result == 'success') {
                    $(this).html(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å`)
                    updateChart(res.data)
                    Swal.fire({
                        title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        html: '<div class="row m-2 rounded" style="height: 40vh;">' + $('#chart-sec').html() + '</div>',
                        icon: 'success',
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    }).then(() => {
                        res = res.data
                        $('.input-data').val('')
                        liff.closeWindow()
                    })
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: '‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö',
                        icon: 'error'
                    })
                }
            })
        })
        function updateChart(data) {
            console.log("üöÄ ~ data", data)
            $('#target-line').text(pesonalData[1].toLocaleString())
            $('#mean-line').text(pesonalData[0].toLocaleString())
            if (data.sum < pesonalData[0]) {
                $('#line-person').text(data.sum.toLocaleString()).closest('.parent-fluid').addClass('text-bg-danger').removeClass('bg-warning').removeClass('text-dark').removeClass('text-bg-success')
            } else if (data.sum >= pesonalData[0] && data.sum < pesonalData[1]) {
                let percent = (data.sum - pesonalData[0]) / (pesonalData[1] - pesonalData[0])
                let percentOf25 = percent * 25
                $('#line-person').text(data.sum.toLocaleString()).closest('.parent-fluid').css('height', 50 + percentOf25 + '%').css('border-bottom-right-radius', '7px').addClass('bg-warning').addClass('text-dark').removeClass('text-bg-danger').removeClass('text-bg-success')
                $('#blank').closest('.parent-fluid').css('height', 50 - percentOf25 + '%').css('border-top-right-radius', '7px')
            } else {
                $('#line-person').text(data.sum.toLocaleString()).closest('.parent-fluid').css('height', '100%').css('border-bottom-right-radius', '7px').css('border-top-right-radius', '7px').addClass('text-bg-success').removeClass('text-bg-danger').removeClass('bg-warning').addClass('text-dark')
                $('#blank').closest('.parent-fluid').css('height', '0%')
            }
        }
        var pesonalData
        $('#btn-regist').click(function () {
            event.preventDefault()
            $('.modal-content').LoadingOverlay('show')
            let sheet = $('#name-select').val()
            $.getJSON(`${script_url}?opt=regist&uid=${profile.userId}&sheet=${sheet}`, (json) => {
                $('.modal-content').LoadingOverlay('hide')
                console.log("üöÄ ~ json", json)
                if (json.result == 'success') {
                    console.log("üöÄ ~ json", json)
                    persanalData = json.gdata
                    $(this).html(`‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô`)
                    $('#modal-regist').modal('hide')
                    Swal.fire({
                        title: 'Success',
                        text: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        icon: 'success'
                    })
                }
            })
        })
        $('#logout-btn').click(() => {
            liff.logout()
            window.location.reload()
        })
        $('#account-btn').click(() => {
            Swal.fire({
                icon: 'question',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏∑‡πà‡∏ô ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                showCancelButton: true,
                confirmButtonText: `‡πÉ‡∏ä‡πà`,
                cancelButtonText: `‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å`,
            }).then((result) => {
                /* Read more about isConfirmed, isDenied below */
                if (result.isConfirmed) {
                    liff.openWindow({
                        url: "https://liff.line.me/1656187634-joNMPmDq?changeAccount=true",
                        external: true
                    });
                    liff.closeWindow()
                }
            })
        })
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
</body>

</html>
